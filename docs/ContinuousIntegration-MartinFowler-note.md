# 持续集成笔记

这篇文章是最早的详细阐述持续集成的文章之一（第一版于2000年发表），也是很多书中的理论来源，且基本上都大量参考了这里列出的观点。

## 持续集成是什么

集成工作可以简单的理解为，把自己的工作成果合并到团队的工作成果中去。持续的含义，是指这一工作不断的频繁进行。

持续集成是这样一种软件开发实践，在这个实践中，项目成员频繁地进行集成工作，通常每人每天都会进行，于是每天会有多次集成。每次集成后都会通过自动化构建（包括测试）来尽快发现其中的错误。许多团队都发现这种方法大大地减少了集成问题并且能够快速地开发出高内聚性的软件。

在作者看来，持续集成应该是“小事一桩”，而不是“一个漫长并且无法预测的过程”。

## 一个用持续集成实践来构建特性的例子

	从主线迁出代码
	进行开发和修改
	完成编码或部分编码（通常包括自测代码等其他手段），现在本地进行私有构建（包含编译、测试等流程）
	如果上述私有构建通过，先要同步其他成员的更新到本地（可能需要处理冲突），重新进行构建直到成功
	先主线提交
	此时，并不代表工作完成，而是在一台集成机器上进行再次构建，直至成功，才算工作完成。（期间的问题应该及时发现并反馈，比如因为遗漏提交文件或其他原因导致，需要第一时间进行修正）
		
按这个例子提供的步骤，我们会得到一个稳定并且工作正常的软件。每个人都围绕着一个共享并稳定的基础代码库工作，绝不离基础代码库太远太久。如此这般，我们花在找bug上的时间减少了，因为bug在频繁的集成中经常出现，省下的时间就可以被用在“更有价值”的地方，为组织创造更大的价值。

当然这些只是工作原理，作者也整理了一些有效持续集成的关键实践。

## 关键的持续集成实践

	只维护一个源码库
	自动化构建
	让你的构建自行测试
	每人每天都要向主线提交代码
	在集成计算机上重新构建主线的每次提交
	立刻修复构建问题
	保持快速构建
	在模拟生产环境中进行测试
	让每个人都能轻易获得最新的可执行文件
	每个人都能看到进度
	自动化部署

作者建议维护一个单一的库，把构建需要的所有东西都放进去（源码、文档、脚本，以及可以“一键”构建出最终成品所需的一切，但尽量不要包含构建的输出）。对于“多分支开发流”，作者也警告不要过度使用，并建议将所需的分支使用数量最小化，及时是大多数人需要“离线”工作，也尽可能的只维护一个单一的开发主线。（这么做的理由也显而易见，因为尽量聚焦在产品主线，会大大减少持续集成工作的难度和工作量，也本应是要追求的目标）

构建工作应该跟IDE解耦，构建脚本和工具，对于自动化过程至关重要。（例如.Net的MSBuild，Ruby的Rake，Java的Ant）

将自动化测试包含到构建过程中，是一种可以快速并高效发现bug的方法，可以根据实际情况，按需按步骤逐步增加自动化测试的力度。

作者的一个基本原则是：越是频繁提交，可能导致冲突的地方就越少，因而也越容易发现问题。

坚持在独立的集成计算机上，进行构建。作者认为定期构建，比如每日/晚构建是不够的。因为持续集成的关键在于尽快地发现问题。而每晚构建意味着整个白天都发现不了bug，如此，需要很长的时间发现并清除这些bug。（但实施总需要一个过程，我们应该循序渐进，增量构建是一个终极目标，而且对于不同的场景，可能采用的策略也稍有不同，比如发版的持续集成策略，不见得一定跟开发主线的持续集成策略一致）

保持自动构建的健康是最紧急、优先级最高的任务。当团队刚引入持续集成，这通常是最难解决的事之一，因为团队早期可能会很难养成保证主线构建的习惯。作者建议不要气馁，保持耐心，毕竟稳定的产品和提升的信心是最好的奖励。

尽量保持快速的构建，例如10钟之内通常是合理的。如果确实有困难，则应该采用阶段式或并行化等手段进行应对。（也可以有选择将耗时的构建过程进行裁剪，按需触发）

应该有一个Staging环境，尽量模拟生产环境。（例如使用相同的数据库，相同的操作系统，并且版本都应该一样。）

人们往往很难预知自己究竟想要什么，而相反，对已有的东西进行评判和修改却容易的多。从这个角度上，让每个人都能轻易获得最新的可执行文件很有意义。

如果团队每个人、每个角色，都能很容易了解项目的最新进展和当前状态，价值显而易见。

将类似部署的人工过程转向自动化，不仅可以加速部署过程，并且能够减少部署错误。甚至可以做的更好些，比如按需进行自动化回滚。

## 持续集成的好处

	降低风险
	加快bug发现
	频繁部署


降低风险：持续集成能够让项目的状态、进度透明
加快bug发现：自测试提供保证、频繁集成降低难度和影响范围，降低修改的难度，有效防止“破窗综合症”。
频繁部署：客户可以快速的尝试软件新功能，及时提出反馈，改善与客户的关系。

## 如何引入持续集成，从哪儿下手？

对于现有的项目，引入持续集成确实有一定难度。不必一开始就尝试做到全部的实践，量体裁衣，循序渐进。

一些建议：

	第一步需要将构建自动化，并将你所需的所有东西都放在代码管理系统中，以至于可以通过一个命令来构建整个系统。
	增量构建如何有难度，可以尝试把日/夜构建作为起点。
	在构建中引入一些自动化测试，从单元测试做起。
	使提交构建快速完成。虽然好几个小时的持续集成比没有要好，但是如果控制在10分钟内最好。
	找有经验的人帮助你。（ThoughtWorks提供这样的咨询服务，毕竟你可能遇到的问题我们之前都遇到过。）


## 延伸阅读

	《Continuous Integration: Improving Software Quality and Reducing Risk》
	《Continuous Delivery: Reliable Software Releases through Build, Test, and Deployment Automation》










