# 持续集成-软件质量改进和风险降低之道

## 前言

一个有趣儿的隐喻：集成按钮

持续集成的定义：

> 持续集成是这样一种软件开发实践，在这个实践中，项目成员频繁地进行集成工作，通常每人每天都会进行，于是每天会有多次集成。每次集成后都会通过自动化构建（包括测试）来尽快发现其中的错误。许多团队都发现这种方法大大地减少了集成问题并且能够快速地开发出高内聚性的软件。


## 启程

> What Is a Build?
A build is much more than a compile (or its dynamic language variations). A build may consist of the compilation, testing, inspection, and deployment—among other things. A build acts as the process for putting source code together and verifying that the software works as a cohesive unit. 

构建的定义：不是仅指编译或其他某种称谓，它可以包含很多过程，例如编译、测试、审查、部署和其他事情。一次构建，就是将源码放在一起，并验证软件可以作为一个一致单元运行的过程。


持续集成 vs 经常集成

持续集成不是要求花更多时间来关注集成，而是恰恰相反，让集成工作变成“小事一桩”，而可以留给开发软件本身更多的时间。

CI流程始于开发人员向代码库提交源码。

CI的基本特性

- 与版本控制系统连接
- 构建脚本
- 反馈机制
- 集成源代码的变更过程（手工或CI服务器）

更多的特性

- 数据库集成
- 测试
- 审查
- 部署
- 文档
- ...

可以选择定期生成文档，而不是持续生成。一个好的CI系统的关键特征是“速度”。CI的基本要素之一，是及时向开发者和项目风险承担者提供反馈信息。

怎样知道自己是正确的进行CI？

- 是否使用版本控制库
- 是否自动化构建
- 是否自动化测试
- 是否自动检测代码标准和规范
- 是否自动反馈
- 是否使用独立的集成计算机进行软件构件

## 引入持续集成

CI对项目中的每一个人，都会产生影响。

### 一个CI的例子

Tim & Lisa
私有构建，及时反馈，测试覆盖率

一些术语

- 自动化 automated
- 持续 continuous
- 集成 intergration
- 持续集成 Continuous Intergration
- 开发环境 development environment
- 审查 inspection
- 构建 build
- 集成构建 intergration build
- 私有构建 private build
- 发布构建 release build
- 品质 quality
- 风险 risk
- 测试 testing

### CI的价值

- 减少风险
	- 缺陷发现和修复变得更快
	- 软件健康度可测（测试、审查）
	- 减少假定（在干净的环境中重复构建和测试）
- 减少重复过程
	- 每次保证执行相同的过程
	- 遵循有序的过程
	- 减少重复劳动
	- 将重要的过程自动化（测试和数据库集成）
- 随时发布
	- 任何时间都可以集成和发布，尤其是关键的节点
- 增强项目可见性
	- 决策更有效
	- 呈现真实的趋势
- 为研发团队建立对产品的信心
	- 更改时有保障，发布时有信心

### 什么阻碍了团队使用CI

> 这些阻碍，讲的比另一本更具体些
> 

- 增加维护CI的开销
	- 这是误解，CI是利用自动化代替手动，原先的问题很可能是该有的过程没有
- 变化太大
	- 循序渐进
- 失败的构建太多
	- 执行私有构建了么？
	- 或许更早的发现了问题？
- 额外的软硬件成本
	- 跟好处相比，不值一提
- 开发者应该执行这些动作
	- 不是替代，而是提供更高效的手段和工具

### 如何进行“持续”集成

“大象放进冰箱”（I Build so Continuously）

- Identify 确定要自动化的步骤（按需裁剪定制）
- Build 创建可以自动化执行这些步骤的构建脚本
- Share 将自动化的工具、脚本和其他需要的一切通过版本控制分享
- Continuous 利用CI确保每次变更后，自动执行这个自动化过程

持续编译 VS 持续集成

### 实现CI的时机

越早越好，已经进展一段时间的项目也不是不可以。

### CI的演进

CI很早就有了，敏捷开发推进了它的发展，它仍在不断演进。马丁的“持续集成”被引用最多。

### CI如何配合其他的实践

看情况，数小时到数月不等。

### CI对团队的基本要求（必须遵守的基本原则）

- 经常提交代码
- 不要提交构建失败的代码
- 立刻修复构建错误
- 编写自动化测试
- 所有测试和审查必须通过
- 集成前要进行私有构建
- 不要获取构建失败的代码

我的理解：

把自动化脚本，加入到版本库中，让它成为自动化构建过程的一部分。CI不仅是一种技术实现，更是一种组织上和文化上的实现，一般采取循序渐进的方式。开发者必须改变自己日常的软件开发习惯。开发者必须经常提交代码，将修复构建问题放在优先的位置，编写任何时候都能通过的自动化测试和脚本，不要将无法构建的代码提交或取出。

## 3 利用CI减少风险

CI直面的问题

- 没有可部署的软件
	- 我机器上可以啊
	- 版本不对，数据库不对
	- 点错了，配置不对
	- ...
- 很晚发现缺陷
	- 回归测试的痛（缺乏自动化测试）
	- 测试覆盖率低（没有标准）
- 项目过程不透明
	- 及时反馈
	- 人工沟通障碍
- 品质没有保障
	- 暴露bug
	- 自动审查机制防止代码臭味（代码规范、重复代码、违反架构等）

## 4 针对每次变更构建软件

### 自动化构建

什么是构建？
构建可以加入很多过程，过程越多，反馈越慢。

### 执行单命令构建

应记住，构建应该是按一下按钮的事情。（单命令构建）
使用现有的构建工具，而不是自己创建。

构建活动通常执行

- 清理
- 编译
- 集成数据库
- 测试
- 审查
- 部署

### 将构建脚本和IDE解耦

IDE可能依赖构建脚本，但反之不应该。

### 集中放置资产

版本库不但放代码

- 第三方组件
- 配置文件
- 初始化数据
- 构建脚本和工具

### 创建一致的目录结构

为了能够有效的进行资产组合，必须创建一致的有逻辑的目录结构

### 让构建快速失败

好的构建知道如何快速失败，节省时间。

### 针对所有环境构建

针对不同的环境应用不同配置

开发
集成
测试（Software）
QA（Staging: Software, Hardware, Enverienment）
生产

### 构建类型和触发机制

并非所有的构建类型都是同样的触发机制

- 私有构建（用户驱动）
- 集成构建（用户驱动，轮询变更，定期执行，事件驱动）
- 发布构建（用户驱动，定期执行）


### 使用专门的构建计算机

避免假设
神器计算机

### 使用CI服务器

CI服务器 VS 手工集成

### 快速构建

10分钟构建

### 分阶段构建

先轻量级，再更全面

### 如何让CI生效

> 这一部分对实际问题的建议可以作为参考，对号入座

- 大型项目
- 遗留项目
- 多版本库
- 分布式开发的版本控制
- 集成时间太长
- 构建老失败
- 没有独立的构建计算机
- 软件太复杂，必须手工？
- 多个分支版本？
	- 这个很贴近我们。“CI集成构建是针对主线的”！必须保证它的稳定，创建分支有合适的理由，但变更必须合并到主线。（项目定制不属于这个套路范畴？一定谨慎对待分支的创建，是否真的有很好的理由？）

> “这一点很重要，CI是针对主线执行的，你必须确保这个主线在任何时候都是稳定的。...创建分支有很好的理由，但变更必须合并到主线上。虽然很多构建管理系统可以针对多个分支进行构建，但CI集成构建是针对主线执行的。”


### 5 数据库集成

我们的现有场景，可以适当简化这个问题。

## 6 持续测试

线性系统的可靠性公式： ALL = A * B * C
.9 * .9 * .9 = .73

### 单元测试

一般是测试独立的单元（比如类），不使用外部依赖（Mock）

### 组件测试

组件测试或子系统测试（也叫集成测试），验证系统的各个部分，有可能使用某些外部依赖

它跟系统测试的不同在于：系统测试仅执行公开的Api，但它不限于此。

### 系统测试

运行整个系统，它区别于功能性测试（完成了系统测试，一般还要执行功能测试 - 手动或自动的）

### 功能测试

系统测试 VS 功能性测试（以用户的视角来测试程序，也叫验收测试）
Seleninum

### 开发者测试的实践

- 单元测试
- 集成测试
- 系统测试
- 功能测试

先执行快的，快速失败。
通过这样的分组，CI系统可以按一种有效的方式进行配置和执行。例如，单元测试在签入时执行，组件测试、系统测试和功能测试定期执行。

以下的测试代码结构可以适当参考：

将单元测试和源代码分别放在两个目录下，例如

	root/
		...
		src/
		test/		
			unit/
			component/
			system/



## 7 持续审查

我们的遗漏项！

## 8 持续部署

做的不够。

## 9 持续反馈

做的不好。


## 一些体会

敏捷开发的很多实践都是相互关联的：

- 持续集成
- 测试驱动
- 代码审查
- 数据库集成
- 信息反馈

人（思想），过程和工具结合。



持续集成的实践思考

- 私有构建
- 集成构建
- 发布构建
